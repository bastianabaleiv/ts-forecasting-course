---
title: "Clase 2"
description: |
  Series de Tiempo: Conceptos, An치lisis, Manipulaci칩n y Visualizaci칩n
author:
  - name: Basti치n Aballay L.
    url: https://www.linkedin.com/in/bastianaballay/
date: "2021-10-25"
bibliography: clase-02.bib
output:
  distill::distill_article:
    toc: true
    toc_depth: 2
    toc_float: true
    code_folding: true
    highlight: tango
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r packages, include=FALSE}
suppressPackageStartupMessages({
  library(tidyverse)
  library(plotly)
  library(xaringanExtra)
})

xaringanExtra::use_panelset()
```

En la [Clase 1](/_site/posts/clase-01) introdujimos las series de tiempo de
manera conceptual como una colecci칩n de observaciones secuenciales en el tiempo.

En esta clase revisaremos las series de tiempo desde una perspectiva te칩rica,
estableciendo los antecendentes estad칤sticos necesarios para analizarlas y
caracterizarlas. Luego de esta clase podr치s:

+ Entender las series de tiempo como *realizaciones* de procesos estoc치sticos
+ Caracterizar series de tiempo utilizando medidas de dependencia
+ Manipular y agregar series de tiempo
+ Proponer visualizaciones adecuadas a la serie de tiempo estudiada
+ Definir indicadores de desempe침o adecuados para evaluar modelos de pron칩stico

Por supuesto, todo lo anterior a trav칠s de la utilizaci칩n de distintos paquetes 
de `R`.

# Series de Tiempo 游늳

Uno de los objetivos principales del an치lisis de series de tiempo es desarrollar
modelos matem치ticos que provean de descripciones plausibles para los datos
muestreados. Para establecer una configuraci칩n estad칤stica que nos permita describir
las series de tiempo, asumiremos que una serie de tiempo puede ser definida como
una colecci칩n de variables aleatorias indexadas de acuerdo al orden en que fueron
obtenidas a trav칠s del tiempo.

<aside>
Series de Tiempo
</aside>

Podemos entonces entender una serie de tiempo como la secuencia de variables aleatorias $y_1,
y_2,y_3,\dots$, donde la variable aleatoria $y_1$ denota el valor que toma la
serie en la primera observaci칩n temporal, la variable $y_2$ denota el valor que
toma el segundo punto en el tiempo y as칤 sucesivamente. Podemos referirnos a dicha secuencia de 
variables aleatorias $\{y_t\} = \{y_1,\dots,y_T\}$, indexada por $t$^[El 칤ndice $t$ usualmente es discreto y toma valores en los enteros] como un *proceso estoc치stico*^[[Cross 
Validated: Is a time series the same as a stochastic process?](https://stats.stackexchange.com/questions/126791/is-a-time-series-the-same-as-a-stochastic-process)]. Luego, los valores observados de una serie de tiempo son una *realizaci칩n* del proceso estoc치stico, siendo una de muchas posibles secuencias que un proceso aleatorio puede generar (@Shumway2017-dp).

<aside>
Proceso estoc치stico
</aside>

Otra manera de ver a las series de tiempo es como una muestra finita que se obtiene de 
una secuencia doblemente infinita subyacente: $\{\dots, y_{-1},y_0,y_1,y_2,\dots,y_T,y_{T+1},y_{T+2},\dots\}$.

En este contexto, un *modelo de series de tiempo* para $\{y_t\}$  es una especificaci칩n
de las distribuciones conjuntas de la sencuencia de variables aleatorias para la cual
$\{y_t\}$ es una realizaci칩n. Dado lo anterior, un modelo de series de tiempo nos permitir치
usar una realizaci칩n para realizar inferencias acerca de la distribuci칩n conjunta
subyacente desde donde se produjo la realizaci칩n obtenida.


```{r}
set.seed(42)

ts_tbl <-  replicate(10, rnorm(300, mean = 0, sd = 1)) %>%
  as_tibble() %>%
  rename_all( ~ paste0("ts_", 1:10)) %>%
  mutate(index = 1:300) %>% 
  pivot_longer(
    cols = -c(index),
    names_to = "series"
  ) %>% 
  mutate(realization = ifelse(series == "ts_1","Yes","No"))
```

::::: {.panelset}

::: {.panel}
[Distribuci칩n de Realizaciones]{.panel-name}
```{r ggplot_sim_ts_all, echo = FALSE}
ggplot_sim_ts_all <- ts_tbl %>% 
  ggplot(
    aes(x = index, y = value, color = series)
  ) +
  geom_line() +
  theme_bw()  

plotly::ggplotly(ggplot_sim_ts_all)

```
:::

::: {.panel}
[Realizaci칩n en particular]{.panel-name}
```{r ggplot_sim_ts_real}
ggplot_sim_ts_real <- ts_tbl %>% 
  ggplot(
    aes(x = index, y = value, color = realization)
  ) +
  geom_line() +
  scale_color_manual(values=c("lightgray","black")) +
  theme_bw()  
  
  plotly::ggplotly(ggplot_sim_ts_real)
```
:::
:::::

# Componentes de una Serie de Tiempo

En la [Clase 1](/_site/posts/clase-01) describimos al an치lisis exploratorio como uno de los objetivos
principales del an치lisis de series de tiempo, haciendo 칠nfasis en la necesidad de 
identificar dichos fen칩menos para poder caracterizar las series estudiadas. 
A continuaci칩n definimos de manera m치s formal a qu칠 nos referiremos cuando 
hablemos de tendencia, estacionalidad y ciclos, entre otros t칠rminos (@Hyndman2021-hc).

## Patrones regulares

### Tendencia

Hablamos de que existe *tendencia* en una serie de tiempo cuando hay un patr칩n
creciente o decreciente a largo plazo^[쯈u칠 es largo plazo de todas maneras?
Para el clima una variaci칩n c칤clica puede ocurrir en un per칤odo de 50 a침os. Si
s칩lo tuvieramos 20 a침os de datos, esta oscilaci칩n podr칤a parecer una tendencia...]
en los datos. Cuando la tendencia cambia de una tendencia creciente a decreciente 
hablamos de un *cambio en la direcci칩n* de la serie. Al analizar la tendencia, es 
necesario considerar la cantidad de observaciones disponible y realizar una
evaluaci칩n subjetiva de a qu칠 nos referimos con *largo plazo*. Existen
m칠todos para estimar o remover la tendencia y as칤 observar de mejor manera
las otras fuentes de variaci칩n de una serie. Finalmente, si la serie no posee tendencia podemos considerarla *estacionaria*^[Retomaremos este concepto de manera m치s formal un poco m치s
adelante] en la media.

<aside>
<p>Tendencia</p>
<p>Estacionariedad</p>
</aside>

```{r}
# Global mean land-ocean temperature deviations (from 1951-1980 average), measured in degrees centigrade, for the years 1880-2015.
ggplot_globtemp <-
  astsa::globtemp %>% 
  timetk::tk_tbl() %>% 
  ggplot(aes(x = index, y = value)) +
  geom_line()

plotly::ggplotly(ggplot_globtemp)
```

### Estacionalidad

Un patr칩n estacional ocurre cuando una serie de tiempo es afectada por factores
estacionales tales como el per칤odo del a침o o el d칤a de la semana. Es decir,
hablamos de una serie con *estacionalidad*  cuando la serie muestra variaciones
sistem치ticas a trav칠s de un per칤odo de tiempo determinado. La estacionalidad
en general es fija y de per칤odo conocido. Este tipo de variaci칩n es f치cil de 
entender y puede ser facilmente estimado si el efecto estacional es de inter칠s directo.
De manera alternativa, tambi칠n es posible remover la variaci칩n estacional de los
datos, para obtener datos *desestacionalizados*, si dicha variaci칩n no es de inter칠s.

<aside>
Estacionalidad
</aside>

```{r}
ggplot_airpassengers <- AirPassengers %>%
  tsibble::as_tsibble() %>%
  mutate(index = as.Date(index)) %>% 
  ggplot((aes(x = index, y = value))) +
  geom_line() +
  theme_bw()

plotly::ggplotly(ggplot_airpassengers)
```


### Ciclicidad

Un *ciclo* ocurre cuando los datos exhiben alzas y bajas que no poseen frecuencia
determinada. Estas fluctuaciones continuas en la tendencia se asocian usualmente
a condiciones econ칩micas determinadas por el tipo de industria o negocio estudiado.
La duraci칩n usual de estas fluctuaciones es de al menos 2 a침os.

> Si las fluctuaciones presentes en una serie de tiempo no poseen una frecuencia
determinada son consideradas c칤clicas. Si la frecuencia es invariante y asociada
a alg칰n aspecto del calendario, entonces el patr칩n es estacional.

## Patrones irregulares

### Irregularidades

Luego de que las variaciones asociadas a patrones de tendencia o estacionalidad
han sido removidos de un set de datos, obtenemos una serie de *residuales*^[Retomaremos
este concepto de manera m치s formal un poco m치s adelante]
que pueden parecer (o no) aleatorios. Los elementos irregulares de una serie de 
tiempo le dan sus caracter칤sticas no-sistem치ticas. Al hacer pron칩sticos, la
idea es *calibrar* cada uno de los componentes de una serie de tiempo en una 
manera precisas excepto por el componente irregular.

<aside>
Residual
</aside>

### Outliers

Desde una perspectiva tradicional, una anomal칤a u *outlier* es una observaci칩n
que se desv칤a con respecto a las otras observaciones lo suficiente como para
generar sospechas acerca de su proceso de generaci칩n. Es decir, un outlier
es una observaciones que no sigue un comportamiento esperado. Si la observaci칩n
es indeseada (por ejemplo un error de medici칩n producto de un sensor
descalibrado o evento de ocurrencia 칰nica en el calendario), usualmente podemos 
limpiarla o imputarla. Sin embargo, si el evento es de inter칠s, quiz치 sea necesario
analizar el outlier de manera aislada (por ejemplo en detecci칩n de fraude).

<aside>
Outliers
</aside>

```{r ggplot_btc_usd_anoms, fig.show = 'hide'}
# devtools::install_github("amrrs/coindeskr")
library(coindeskr)

# Obtenemos precio historico del Bitcoin en USd췂
btc_usd_tbl <-
  get_historic_price('USD', '2019-01-01', '2021-10-25') %>%
  timetk::tk_tbl() %>%
  rename(Date = index)

# devtools::install_github("twitter/AnomalyDetection")
# Deteccion de anomalias
library(AnomalyDetection)
btc_usd_anoms <-
  AnomalyDetectionTs(
    btc_usd_tbl,
    max_anoms = 0.05,
    direction = 'both',
    plot = FALSE
  )

# Graficamos
ggplot_btc_usd_anoms <- btc_usd_anoms$anoms %>%
  as_tibble() %>%
  mutate(Date = as.Date(timestamp), .keep = "unused") %>%
  left_join(btc_usd_tbl, .) %>%
  ggplot(aes(x = Date, y = Price)) +
  geom_line() +
  geom_point(aes(y = anoms), color = 'red') +
  theme_bw()

plotly::ggplotly(ggplot_btc_usd_anoms)
```


### Cambios estructurales

Un cambio estructural (a veces llamados cambios de r칠gimen) es un cambio repentino e inesperado en el comportamiento de una serie de tiempo. En t칠rminos estad칤sticos, un cambio estructural ocurre cuando la distribuci칩n de probabilidad subyacente de una serie de tiempo cambia. El proceso de detecci칩n de puntos de cambios^[V칠ase paquete [`changepoint`](https://www.lancs.ac.uk/~killick/Pub/KillickEckley2011.pdf)] busca identificar cuando ocurren estos cambios, usualmente utilizando
algoritmos que comparan propiedades estad칤sticas de la distribuci칩n nueva con respecto a la original.

```{r}
library(changepoint)

set.seed(42)

# Simulamos a partir de una distribucion normal
ts_sim <-
  c(rnorm(100, mean = 0, sd = 1),
    rnorm(100, mean = 1, sd = 1),
    rnorm(100, mean = 0, sd = 1),
    rnorm(100, mean = 0.2, sd = 1))

# Calculamos posicionamiento optimo y cantidad (potencial) de
# puntos de cambio en los datos usando PELT
ts_pelt <- cpt.mean(ts_sim, method='PELT')

# [!] Notar que ts_pelt es un objeto clase S4
# Establecemos la media para cada intervalo hallado
ts_levels <-
  rep(ts_pelt@param.est$mean, 
      times = c(ts_pelt@cpts[1], diff(ts_pelt@cpts)))

# Generamos tibble que reune resultados
ts_cpoint_tbl <-
  dplyr::tibble(index = 1:400,
                ts = ts_sim,
                ts_level = ts_levels)

# Grafico
ggplot_ts_cpoint <- ts_cpoint_tbl %>%
  ggplot(aes(x = index, y = ts_sim)) +
  geom_line() +
  geom_line(y = ts_levels, color = 'red') +
  theme_bw()

plotly::ggplotly(ggplot_ts_cpoint)
```


## Modelos de Series de Tiempo

El grado de suavidad de las series de tiempo revisadas en la [clase pasada](/_site/posts/clase-01/index.html#introST) es una de las caracter칤sticas
fundamentales que nos permite diferenciarlas entre ellas. Como vimos anteriormente,
podr칤amos suponer que los puntos adyacentes en el tiempo est치n *correlacionados*,
por lo que el valor de la serie en el per칤odo $t$, $y_t$, depender칤a de alg칰n modo
de sus valores pasados $y_{t-1}, y_{t-2},\dots$. Podemos incorporar dicha suposici칩n
junto a colecciones de variables aleatorias para modelar series de tiempo.

A continuaci칩n revisaremos la serie m치s simple que podemos generar: una colecci칩n
de variables aleatorias no correlacionadas utilizando la distribuci칩n normal.

## Ruido Blanco

El *ruido blanco*^[En ingl칠s White Noise (WN), en analog칤a con la luz blanca y la idea
de que todas las oscilaciones peri칩dicas posibles est치n presentes en ella con igual fuerza.]
es uno los ejemplos m치s simples de un proceso estacionario.

<aside>
Ruido Blanco
</aside>


## Estacionariedad

## Autocorrelaci칩n y Autocorrelaci칩n Parcial

### Ruido Blanco

## Manipulaci칩n y agregaci칩n de series de tiempo

+ Desaf칤os: saber qu칠 utilizar
+ Evoluci칩n de los paquetes en el tiempo: hipervinculo a secci칩n de recursos
con paquetes propuestos

# Evaluaci칩n de pron칩sticos

La mayor칤a de los an치lisis estad칤sticos buscan estimar propiedades de la poblaci칩n
a partir de una muestra. En el caso del an치lisis de series de tiempo, el problema
es distinto: pese a que podemos modificar el largo de la serie de tiempo observada,
es imposible obtener m칰ltiples observaciones en un punto espec칤fico del tiempo. 
Por lo tanto, los procedimientos estad칤sticos convencionales (basados en estimadores
obtenidos a partir de muestras grandes) dejan de ser apropiados para las series de tiempo.

---

```{r}
sessionInfo()
```
